{
  "openapi": "3.0.1",
  "info": {
    "title": "HIS 医院信息管理系统 API 文档",
    "description": "医院信息管理系统 RESTful API 接口文档，包含挂号、就诊、处方、收费等模块",
    "contact": {
      "name": "HIS 开发团队",
      "email": "his-dev@example.com"
    },
    "license": {
      "name": "Apache 2.0",
      "url": "https://www.apache.org/licenses/LICENSE-2.0.html"
    },
    "version": "1.0.0"
  },
  "servers": [
    {
      "url": "http://localhost:8080",
      "description": "Generated server url"
    }
  ],
  "tags": [
    {
      "name": "药房管理",
      "description": "药房相关接口，包括发药、退药、库存查询等操作"
    },
    {
      "name": "基础数据接口",
      "description": "提供科室、医生等基础数据查询，用于前端挂号界面"
    },
    {
      "name": "挂号管理",
      "description": "患者挂号相关接口，包括挂号、查询、取消等操作"
    },
    {
      "name": "医生工作站",
      "description": "医生工作站相关接口，包括候诊列表查询、接诊、完成就诊等操作"
    },
    {
      "name": "认证管理",
      "description": "用户登录、登出等认证相关接口"
    }
  ],
  "paths": {
    "/api/registrations/{id}/refund": {
      "put": {
        "tags": [
          "挂号管理"
        ],
        "summary": "挂号退费",
        "description": "将已取消的挂号记录标记为已退费状态",
        "operationId": "refund",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "挂号记录ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultVoid"
                }
              }
            }
          }
        }
      }
    },
    "/api/registrations/{id}/cancel": {
      "put": {
        "tags": [
          "挂号管理"
        ],
        "summary": "取消挂号",
        "description": "取消指定的挂号记录，状态变更为已取消",
        "operationId": "cancel",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "挂号记录ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          },
          {
            "name": "reason",
            "in": "query",
            "description": "取消原因",
            "required": false,
            "schema": {
              "type": "string"
            },
            "example": "患者临时有事"
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultVoid"
                }
              }
            }
          }
        }
      }
    },
    "/api/doctor/registrations/{id}/status": {
      "put": {
        "tags": [
          "医生工作站"
        ],
        "summary": "更新就诊状态",
        "description": "医生接诊或完成就诊，将挂号状态从待就诊更新为已就诊。【安全特性】强制从JWT Token获取医生ID并验证权限，防止水平越权（IDOR）攻击：医生只能更新自己患者的挂号状态，无法通过伪造ID来更新其他医生的患者记录。",
        "operationId": "updateStatus",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "挂号记录ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          },
          {
            "name": "status",
            "in": "query",
            "description": "新状态码（1=已就诊）",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int32"
            },
            "example": 1
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultVoid"
                }
              }
            }
          }
        }
      }
    },
    "/auth/logout": {
      "post": {
        "tags": [
          "认证管理"
        ],
        "summary": "用户登出",
        "description": "用户登出系统（JWT 模式下客户端删除 Token 即可）",
        "operationId": "logout",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/auth/login": {
      "post": {
        "tags": [
          "认证管理"
        ],
        "summary": "用户登录",
        "description": "用户通过用户名和密码登录系统，返回 JWT Token",
        "operationId": "login",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/LoginRequest"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultLoginVO"
                }
              }
            }
          }
        }
      }
    },
    "/api/registrations": {
      "post": {
        "tags": [
          "挂号管理"
        ],
        "summary": "患者挂号",
        "description": "创建新的挂号记录，如果患者不存在则自动创建患者档案",
        "operationId": "register",
        "requestBody": {
          "content": {
            "application/json": {
              "schema": {
                "$ref": "#/components/schemas/RegistrationDTO"
              }
            }
          },
          "required": true
        },
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultRegistrationVO"
                }
              }
            }
          }
        }
      }
    },
    "/api/medicine/return": {
      "post": {
        "tags": [
          "药房管理"
        ],
        "summary": "退药",
        "description": "为已发药记录进行退药操作，自动归还库存",
        "operationId": "returnMedicine",
        "parameters": [
          {
            "name": "dispenseId",
            "in": "query",
            "description": "发药记录ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          },
          {
            "name": "reason",
            "in": "query",
            "description": "退药原因",
            "required": true,
            "schema": {
              "type": "string"
            },
            "example": "患者要求退药"
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/api/medicine/dispense": {
      "post": {
        "tags": [
          "药房管理"
        ],
        "summary": "发药",
        "description": "根据处方ID进行发药操作，自动扣减库存",
        "operationId": "dispenseMedicine",
        "parameters": [
          {
            "name": "prescriptionId",
            "in": "query",
            "description": "处方ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/auth/validate": {
      "get": {
        "tags": [
          "认证管理"
        ],
        "summary": "验证Token",
        "description": "验证 JWT Token 是否有效",
        "operationId": "validateToken",
        "parameters": [
          {
            "name": "Authorization",
            "in": "header",
            "required": true,
            "schema": {
              "type": "string"
            }
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultBoolean"
                }
              }
            }
          }
        }
      }
    },
    "/api/registrations/{id}": {
      "get": {
        "tags": [
          "挂号管理"
        ],
        "summary": "查询挂号记录",
        "description": "根据挂号记录ID查询详细信息",
        "operationId": "getById",
        "parameters": [
          {
            "name": "id",
            "in": "path",
            "description": "挂号记录ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultRegistrationVO"
                }
              }
            }
          }
        }
      }
    },
    "/api/medicine/stock": {
      "get": {
        "tags": [
          "药房管理"
        ],
        "summary": "查询药品库存",
        "description": "查询药品库存信息，支持关键字搜索和低库存筛选",
        "operationId": "getStock",
        "parameters": [
          {
            "name": "keyword",
            "in": "query",
            "description": "药品名称关键字（可选）",
            "required": false,
            "schema": {
              "type": "string"
            },
            "example": "阿莫西林"
          },
          {
            "name": "lowStock",
            "in": "query",
            "description": "是否只查询低库存药品",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            },
            "example": false
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/api/medicine/statistics/today": {
      "get": {
        "tags": [
          "药房管理"
        ],
        "summary": "今日发药统计",
        "description": "统计当前药师今日的发药数量、处方数等信息",
        "operationId": "getTodayStatistics",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/api/medicine/pending": {
      "get": {
        "tags": [
          "药房管理"
        ],
        "summary": "待发药列表",
        "description": "查询所有已缴费但未发药的处方列表",
        "operationId": "getPendingDispenseList",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultString"
                }
              }
            }
          }
        }
      }
    },
    "/api/doctor/waiting-list": {
      "get": {
        "tags": [
          "医生工作站"
        ],
        "summary": "查询今日候诊列表（支持个人/科室视图切换）",
        "description": "【安全特性】强制从JWT Token获取医生ID，防止水平越权（IDOR）攻击。默认显示分配给当前医生的候诊患者（个人视图），设置showAll=true可查看整个科室的候诊患者（科室视图）。按排队号升序排列。医生信息完全从JWT Token中获取，前端传递的任何doctorId参数将被忽略。",
        "operationId": "getWaitingList",
        "parameters": [
          {
            "name": "showAll",
            "in": "query",
            "description": "是否显示科室所有患者（false=个人视图，true=科室视图）",
            "required": false,
            "schema": {
              "type": "boolean",
              "default": false
            },
            "example": false
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultListRegistrationVO"
                }
              }
            }
          }
        }
      }
    },
    "/api/basic/doctors": {
      "get": {
        "tags": [
          "基础数据接口"
        ],
        "summary": "获取医生列表",
        "description": "根据科室ID获取该科室下所有启用的医生列表（含状态和挂号费），用于挂号界面下拉选择",
        "operationId": "getDoctorsByDepartment",
        "parameters": [
          {
            "name": "deptId",
            "in": "query",
            "description": "科室ID",
            "required": true,
            "schema": {
              "type": "integer",
              "format": "int64"
            },
            "example": 1
          }
        ],
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultListDoctorBasicVO"
                }
              }
            }
          }
        }
      }
    },
    "/api/basic/departments": {
      "get": {
        "tags": [
          "基础数据接口"
        ],
        "summary": "获取科室列表",
        "description": "获取所有启用的科室列表，用于挂号界面下拉选择",
        "operationId": "getDepartments",
        "responses": {
          "200": {
            "description": "OK",
            "content": {
              "*/*": {
                "schema": {
                  "$ref": "#/components/schemas/ResultListDepartmentBasicVO"
                }
              }
            }
          }
        }
      }
    }
  },
  "components": {
    "schemas": {
      "ResultVoid": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32",
            "description": "响应状态码（200=成功, 400=失败）"
          },
          "message": {
            "type": "string",
            "description": "响应消息"
          },
          "data": {
            "type": "object",
            "description": "无返回数据"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64",
            "description": "时间戳"
          }
        }
      },
      "ResultString": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "type": "string"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "LoginRequest": {
        "required": [
          "password",
          "username"
        ],
        "type": "object",
        "properties": {
          "username": {
            "type": "string",
            "description": "用户名",
            "example": "admin",
            "refType": null
          },
          "password": {
            "type": "string",
            "description": "密码",
            "example": "admin123",
            "refType": null
          }
        },
        "description": "登录请求"
      },
      "LoginVO": {
        "type": "object",
        "properties": {
          "token": {
            "type": "string",
            "description": "JWT Token",
            "example": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "refType": null
          },
          "role": {
            "type": "string",
            "description": "用户角色",
            "example": "ADMIN",
            "refType": null
          },
          "realName": {
            "type": "string",
            "description": "真实姓名",
            "example": "张三",
            "refType": null
          },
          "userId": {
            "type": "integer",
            "description": "用户ID",
            "format": "int64",
            "example": 1,
            "refType": null
          },
          "relatedId": {
            "type": "integer",
            "description": "关联ID（医生ID等）",
            "format": "int64",
            "example": 10,
            "refType": null
          }
        },
        "description": "登录响应"
      },
      "ResultLoginVO": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "$ref": "#/components/schemas/LoginVO"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "RegistrationDTO": {
        "required": [
          "age",
          "deptId",
          "doctorId",
          "gender",
          "idCard",
          "patientName",
          "phone",
          "regFee"
        ],
        "type": "object",
        "properties": {
          "patientName": {
            "type": "string",
            "description": "患者姓名",
            "example": "李明"
          },
          "idCard": {
            "type": "string",
            "description": "身份证号",
            "example": "110101199001011001"
          },
          "gender": {
            "type": "integer",
            "description": "性别（0=女, 1=男, 2=未知）",
            "format": "int32",
            "example": 1
          },
          "age": {
            "type": "integer",
            "description": "年龄",
            "format": "int32",
            "example": 34
          },
          "phone": {
            "type": "string",
            "description": "联系电话",
            "example": "13912345678"
          },
          "deptId": {
            "type": "integer",
            "description": "科室ID",
            "format": "int64",
            "example": 1
          },
          "doctorId": {
            "type": "integer",
            "description": "医生ID",
            "format": "int64",
            "example": 1
          },
          "regFee": {
            "type": "number",
            "description": "挂号费（单位：元）",
            "example": 20
          }
        },
        "description": "挂号请求数据"
      },
      "RegistrationVO": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "format": "int64",
            "description": "挂号记录 ID"
          },
          "regNo": {
            "type": "string",
            "description": "挂号流水号"
          },
          "patientName": {
            "type": "string",
            "description": "患者姓名"
          },
          "patientId": {
            "type": "integer",
            "format": "int64",
            "description": "患者 ID"
          },
          "gender": {
            "type": "integer",
            "format": "int32",
            "description": "患者性别（0=女, 1=男, 2=未知）"
          },
          "age": {
            "type": "integer",
            "format": "int32",
            "description": "患者年龄"
          },
          "deptId": {
            "type": "integer",
            "format": "int64",
            "description": "科室 ID"
          },
          "deptName": {
            "type": "string",
            "description": "科室名称"
          },
          "doctorId": {
            "type": "integer",
            "format": "int64",
            "description": "医生 ID"
          },
          "doctorName": {
            "type": "string",
            "description": "医生姓名"
          },
          "status": {
            "type": "integer",
            "format": "int32",
            "description": "挂号状态（0=待就诊, 1=已就诊, 2=已取消）"
          },
          "statusDesc": {
            "type": "string",
            "description": "状态描述"
          },
          "visitDate": {
            "type": "string",
            "format": "date",
            "description": "就诊日期"
          },
          "registrationFee": {
            "type": "number",
            "description": "挂号费"
          },
          "queueNo": {
            "type": "string",
            "description": "排队号"
          },
          "appointmentTime": {
            "type": "string",
            "format": "date-time",
            "description": "预约时间"
          },
          "createdAt": {
            "type": "string",
            "format": "date-time",
            "description": "创建时间"
          }
        }
      },
      "ResultRegistrationVO": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32",
            "description": "响应状态码（200=成功, 400=失败）"
          },
          "message": {
            "type": "string",
            "description": "响应消息"
          },
          "data": {
            "$ref": "#/components/schemas/RegistrationVO",
            "description": "挂号信息"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64",
            "description": "时间戳"
          }
        }
      },
      "ResultBoolean": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "type": "boolean"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "ResultListRegistrationVO": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32",
            "description": "响应状态码（200=成功, 400=失败）"
          },
          "message": {
            "type": "string",
            "description": "响应消息"
          },
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/RegistrationVO"
            },
            "description": "挂号列表"
          },
          "timestamp": {
            "type": "integer",
            "format": "int64",
            "description": "时间戳"
          }
        }
      },
      "DoctorBasicVO": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "医生ID",
            "format": "int64"
          },
          "doctorNo": {
            "type": "string",
            "description": "医生工号"
          },
          "name": {
            "type": "string",
            "description": "医生姓名"
          },
          "gender": {
            "type": "integer",
            "description": "性别（0=女, 1=男, 2=未知）",
            "format": "int32"
          },
          "genderText": {
            "type": "string",
            "description": "性别文本"
          },
          "title": {
            "type": "string",
            "description": "职称"
          },
          "specialty": {
            "type": "string",
            "description": "专长"
          },
          "status": {
            "type": "integer",
            "description": "状态（0=停用, 1=启用）",
            "format": "int32"
          },
          "statusText": {
            "type": "string",
            "description": "状态文本"
          },
          "departmentId": {
            "type": "integer",
            "description": "所属科室ID",
            "format": "int64"
          },
          "departmentName": {
            "type": "string",
            "description": "所属科室名称"
          },
          "registrationFee": {
            "type": "number",
            "description": "挂号费（元）",
            "example": 50
          }
        },
        "description": "医生基础信息"
      },
      "ResultListDoctorBasicVO": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DoctorBasicVO"
            }
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      },
      "DepartmentBasicVO": {
        "type": "object",
        "properties": {
          "id": {
            "type": "integer",
            "description": "科室ID",
            "format": "int64"
          },
          "code": {
            "type": "string",
            "description": "科室代码"
          },
          "name": {
            "type": "string",
            "description": "科室名称"
          },
          "parentId": {
            "type": "integer",
            "description": "上级科室ID",
            "format": "int64"
          },
          "parentName": {
            "type": "string",
            "description": "上级科室名称"
          }
        },
        "description": "科室基础信息"
      },
      "ResultListDepartmentBasicVO": {
        "type": "object",
        "properties": {
          "code": {
            "type": "integer",
            "format": "int32"
          },
          "message": {
            "type": "string"
          },
          "data": {
            "type": "array",
            "items": {
              "$ref": "#/components/schemas/DepartmentBasicVO"
            }
          },
          "timestamp": {
            "type": "integer",
            "format": "int64"
          }
        }
      }
    }
  }
}