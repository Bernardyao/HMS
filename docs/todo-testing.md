# 测试与交付 TODO — HIS

> 角色：测试/交付负责人（QA & DevOps）
> 范围：对应当前数据库 9 表与门诊闭环全链路验证
> 目标：保证可测试、可发布、可回滚、可追责

---

## P0（本迭代必须完成）

### 1) 测试环境与数据准备
- 搭建测试环境：
  - Dev 环境：开发自测用
  - Test/Staging 环境：集成测试与验收用
  - 数据库初始化脚本（建表 + 基础数据：科室/医生/药品样例）
- 测试数据脚本：
  - 准备 10+ 患者测试数据（覆盖不同性别/年龄段/有无身份证）
  - 准备 5+ 科室与对应医生数据
  - 准备 20+ 药品数据（含不同价格/库存状态）
- 可重置机制：一键清理测试数据并重新初始化（保留基础主数据）

### 2) 核心业务冒烟测试清单（手工验证）
> 每次发布前必须全部通过

**主数据模块**
- [ ] 科室管理：创建科室 → 编辑 → 启停用 → 软删除
- [ ] 医生管理：创建医生（选择科室）→ 编辑 → 启停用 → 软删除
- [ ] 患者建档：创建患者（含身份证）→ 编辑 → 按手机号查询 → 软删除
- [ ] 药品管理：创建药品 → 编辑价格/库存 → 启停用 → 软删除

**门诊闭环（Happy Path）**
- [ ] 挂号：为已有患者创建挂号 → 查看挂号列表（按日期筛选）
- [ ] 病历：从挂号进入病历 → 填写病历内容 → 保存草稿 → 提交 → 审核通过
- [ ] 处方：从病历开处方 → 添加 3 条药品明细 → 保存草稿 → 开方 → 审核 → 发药
- [ ] 收费：创建收费单（关联挂号）→ 支付回写（模拟支付）→ 查看已缴费状态

**异常流程（Unhappy Path）**
- [ ] 挂号取消：创建挂号 → 取消挂号（填写原因）→ 验证状态变为"已取消"
- [ ] 病历重复创建：对同一挂号二次创建病历 → 验证后端拒绝（一对一约束）
- [ ] 处方金额不一致：修改前端明细小计与后端计算不符 → 验证后端拒绝
- [ ] 收费重复支付：同一 transaction_no 二次回写 → 验证幂等（不重复入账）
- [ ] 收费退费：已缴费订单 → 退费（填写原因）→ 验证状态与退费金额

### 3) 接口自动化测试（优先级最高）
> 使用 Postman/RestAssured/JUnit + 测试容器

**主数据接口**
- 科室 CRUD + 部分唯一约束（dept_code）
- 医生 CRUD + 外键约束（department_main_id）
- 患者 CRUD + 身份证唯一性（非空时）
- 药品 CRUD + 部分唯一约束（medicine_code）

**门诊闭环接口**
- 挂号创建/取消/列表查询（按 visit_date + status + department 筛选）
- 病历创建/草稿保存/提交/审核（一对一约束验证）
- 处方主从写入/金额复算校验/审核/发药（事务一致性）
- 收费创建/支付回写（幂等键验证）/退费

**边界与异常测试**
- 必填字段缺失 → 400 Bad Request + 字段级错误
- 唯一约束冲突 → 409 Conflict + DUPLICATE_KEY 错误码
- 状态机非法流转 → 400 + INVALID_STATE_TRANSITION
- 外键不存在 → 400 + FOREIGN_KEY_NOT_FOUND
- 金额/数量非法值（负数/0）→ 400

### 4) 数据一致性专项测试
- 处方明细小计 vs 处方主表总额：
  - 前端提交 subtotal 与后端复算不一致 → 拒绝
  - 主表 total_amount 与明细汇总不一致 → 拒绝
- 收费金额关系验证：
  - actual_amount = total_amount - discount_amount - insurance_amount - refund_amount
  - 验证后端校验规则生效
- 软删除一致性：
  - 软删除后再创建同 code 记录 → 成功（不受唯一索引影响）

### 5) 权限与脱敏测试（MVP）
- 未登录访问 → 401 Unauthorized
- 医生角色访问收费接口 → 403 Forbidden（按权限设计）
- 收费员角色访问处方审核 → 403 Forbidden
- 患者列表脱敏：验证手机号/身份证默认脱敏（如 138****1234）
- 详情页明文权限：仅管理员/授权角色可查看明文

---

## P1（2–3 周内完成）

### 1) 性能与压力测试（基线）
- 并发挂号：10 并发用户同时创建挂号 → 响应时间 < 2s，成功率 100%
- 并发处方创建：5 并发医生同时开处方 → 事务隔离验证，无脏数据
- 支付并发回写：同一 transaction_no 10 次并发 → 幂等验证（仅入账 1 次）
- 列表查询性能：挂号列表按日期查询 1000 条 → 响应时间 < 1s

### 2) 回归测试自动化
- 建立回归测试套件（接口 + UI 关键路径）
- 每次发布前必须全量跑回归 → 通过率 ≥ 95%

### 3) CI/CD 流水线
- 代码提交 → 自动触发：
  - 编译 + 单元测试
  - 接口自动化测试（Dev 环境）
  - 代码扫描（SonarQube/CheckStyle）
- PR 合并前：CI 必须通过
- 发布流程：
  - Dev → Test → Staging → Prod
  - 每个环境有独立数据库与配置
  - Staging 验收通过后才能发 Prod

### 4) 发布与回滚预案
- 发布检查清单：
  - [ ] 数据库迁移脚本已在 Staging 执行并验收
  - [ ] 接口自动化测试通过
  - [ ] 冒烟测试通过
  - [ ] 备份策略已确认（数据库 + 应用版本）
  - [ ] 回滚预案已准备（回滚脚本 + 数据补偿）
- 回滚触发条件：
  - 核心链路不可用（挂号/收费失败）
  - 数据一致性问题（金额错误/重复入账）
  - 安全漏洞发现
- 回滚步骤：
  1. 停止新版本应用
  2. 启动上一版本应用
  3. 回滚数据库迁移（如有）
  4. 验证核心链路可用
  5. 记录回滚日志与复盘

---

## P2（持续优化）

### 1) 测试覆盖率与质量度量
- 单元测试覆盖率 ≥ 70%（关键业务逻辑 ≥ 90%）
- 接口测试覆盖率 ≥ 80%（核心 API 100%）
- 缺陷逃逸率 < 5%（生产发现缺陷 / 总缺陷）

### 2) 监控与告警
- 应用监控：
  - 错误率告警（5xx > 1%）
  - 响应时间告警（P95 > 3s）
  - 接口可用性告警（核心 API 可用性 < 99%）
- 数据库监控：
  - 慢查询告警（> 1s）
  - 连接数告警（> 80% 上限）
  - 磁盘空间告警（> 80%）
- 业务监控：
  - 支付成功率 < 95%
  - 挂号创建失败率 > 2%

### 3) 安全测试
- SQL 注入测试（关键输入参数）
- XSS 测试（富文本字段：病历内容/医嘱）
- CSRF 测试（状态变更接口）
- 敏感数据传输加密验证（HTTPS）
- 会话劫持测试（Token/Session 安全性）

### 4) 兼容性测试
- 浏览器兼容：Chrome/Edge/Firefox 最新版
- 屏幕分辨率：1920x1080、1366x768
- 移动端适配（如有要求）

---

## 测试数据管理

### 标准测试数据集
- 患者数据：
  - 正常患者 10 个（不同性别/年龄/有无身份证）
  - 边界患者：年龄 0/120、手机号空、身份证重复
- 医生数据：5 个医生分属不同科室
- 科室数据：3 级科室树（根科室 → 二级 → 三级）
- 药品数据：
  - 正常药品 20 个（不同价格/库存）
  - 边界药品：库存 0、价格 0.0001、超长药品名

### 数据清理与隔离
- 测试数据标记：用特定前缀（如 `TEST_`）标识测试数据
- 自动清理脚本：定期清理测试环境老旧数据（> 7 天）
- 数据隔离：测试环境严禁使用生产真实数据

---

## 测试工具与环境

### 必备工具
- 接口测试：Postman/RestAssured/JUnit 5
- 数据库工具：DBeaver/pgAdmin（用于数据验证）
- 版本控制：Git + 测试脚本纳入版本管理
- CI/CD：Jenkins/GitLab CI/GitHub Actions
- 缺陷管理：Jira/Redmine/禅道

### 环境配置
- Dev：开发自测，数据可随意修改
- Test：集成测试，定期重置数据
- Staging：预生产，配置与 Prod 一致，用于最终验收
- Prod：生产环境，严格发布流程

---

## 验收标准（质量门禁）

### 功能验收
- [ ] 冒烟测试清单 100% 通过
- [ ] 核心业务闭环可演示（患者 → 挂号 → 病历 → 处方 → 收费）
- [ ] 异常流程验证通过（取消/退费/状态机拒绝）

### 自动化验收
- [ ] 接口自动化测试通过率 ≥ 95%
- [ ] 回归测试通过率 ≥ 95%

### 性能验收
- [ ] 核心接口响应时间 P95 < 2s
- [ ] 并发支付幂等验证通过

### 安全验收
- [ ] 权限控制生效（角色隔离）
- [ ] 脱敏展示生效（手机号/身份证）
- [ ] 审计日志可追溯（关键操作有记录）

---

## 参考文档
- 企划书：docs/project-proposal.md
- 后端参考：docs/backend-db-reference.md
- 前端字典：docs/frontend-data-dictionary.md
- 开发流程：docs/dev-process-3person.md
- 前端 TODO：docs/todo-frontend.md
- 后端 TODO：docs/todo-backend.md
